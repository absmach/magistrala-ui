<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "dashboards" }}
  <!doctype html>
  <html lang="en">
    <head>
      {{ template "header" }}
      <link rel="stylesheet" href="/css/dashboards.css" />
      <title>Dashboards</title>
    </head>
    <body>
      {{ template "navbar" . }}
      <div class="main-content pt-3">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto py-3">
              <div id="dashboard-alert"></div>
              <div class="row-mb-3">
                <button class="btn body-button" type="button" onclick="newDashboard()">
                  New Dashboard
                </button>
              </div>
              <div class="row" id="dashboard-cards-container"></div>
              <div id="dashboard-loader" class="row justify-content-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div class="card-actions">
                <span>
                  Showing
                  <span id="cards-count"></span>
                  of
                  <span id="cards-total"></span>
                  cards
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Create Dashboard modal -->
      <div
        class="modal fade"
        id="createDashboardModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="createDashboardModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="createDashboardModalLabel">Create Dashboard</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <form action="/dashboards" method="post">
              <div class="modal-body">
                <div class="mb-3">
                  <label for="dashboard-name" class="form-label">Name</label>
                  <input
                    type="text"
                    class="form-control"
                    name="name"
                    id="dashboard-name"
                    placeholder="Enter the dashboard name"
                  />
                </div>
                <div class="mb-3">
                  <label for="dashboard-description" class="form-label">Description</label>
                  <textarea
                    class="form-control"
                    name="description"
                    id="dashboard-description"
                    placeholder="Enter the dashboard description"
                  ></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn body-button">Create</button>
                <button type="button" class="btn body-button" data-bs-dismiss="modal">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- update dashboard modal -->
      <div
        class="modal fade"
        id="updateDashboardModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="updateDashboardModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="updateDashboardModalLabel">Update Dashboard</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <form id="update-dashboard-form">
              <div class="modal-body">
                <input type="hidden" name="id" id="id" />
                <div class="mb-3">
                  <label for="dashboard-name" class="form-label">Name</label>
                  <input type="text" class="form-control" name="name" id="dashboard-name" />
                </div>
                <div class="mb-3">
                  <label for="dashboard-description" class="form-label">Description</label>
                  <textarea
                    class="form-control"
                    name="description"
                    id="dashboard-description"
                  ></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn body-button" id="update-dashboard-button">
                  Update
                </button>
                <button type="button" class="btn body-button" data-bs-dismiss="modal">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <script>
        const newDashboard = () => {
          const modal = new bootstrap.Modal(document.getElementById("createDashboardModal"));
          modal.show();
        };

        // Infinite scroll code start
        const cardsRow = document.getElementById("dashboard-cards-container");
        const cardCountElem = document.getElementById("cards-count");
        const cardTotalElem = document.getElementById("cards-total");
        let currentPage = 1;
        let limit = 30;
        var total, pageCount;

        const addCards = (pageIndex) => {
          currentPage = pageIndex;
          fetch(`/dashboards/list?page=${pageIndex}&limit=${limit}`, {
            method: "GET",
          })
            .then((response) => response.json())
            .then((data) => {
              createCard(data);
              total = data.total;
              cardTotalElem.innerHTML = total;
              limit = data.limit;
              pageCount = data.pages;
              const endRange = currentPage == pageCount ? total : pageIndex * limit;
              cardCountElem.innerHTML = endRange;
            })
            .catch((error) => console.error("Error:", error));
        };

        window.onload = () => {
          addCards(currentPage);
          if (currentPage === pageCount) {
            document.getElementById("dashboard-loader").remove();
          }
        };

        const handleInfiniteScroll = () => {
          let { clientHeight, scrollHeight, scrollTop } = document.documentElement;
          if (clientHeight + scrollTop + 1 >= scrollHeight) {
            addCards(currentPage + 1);
          }
          if (currentPage === pageCount) {
            removeInfiniteScroll();
          }
        };

        window.addEventListener("scroll", handleInfiniteScroll);

        const removeInfiniteScroll = () => {
          document.getElementById("dashboard-loader").remove();
          window.removeEventListener("scroll", handleInfiniteScroll);
        };

        // Infinite scroll code end

        // Create card creates a new card for each dashboard.
        function createCard(data) {
          setTimeout(() => {
            data.dashboards.forEach((dashboard) => {
              const newDiv = document.createElement("div");
              newDiv.className = "col-12 col-md-6 col-lg-4 mb-3";
              newDiv.innerHTML = `
                <div class="card">
                  <a href="/dashboards/${dashboard.id}" class="card-link">
                    <div class="card-header text-center">
                      <h5 class="card-title">${dashboard.name}</h5>
                      <h6 class="text-muted fs-6 dashboard-card-id">${dashboard.id}</h6>
                    </div>
                    <div class="card-body">
                      <p class="card-text dashboard-card-description">
                        ${dashboard.description}
                      </p>
                      
                    </div>
                  </a>
                  <div class="card-footer buttons">
                    <button type="button" class="btn me-2" onclick="deleteDashboard('${dashboard.id}')">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                    <button
                      type="button"
                      class="btn me-2"
                      onclick="editDashboard('${dashboard.id}', '${dashboard.name}', '${dashboard.description}')"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                  </div>
                </div>
                `;
              cardsRow.appendChild(newDiv);
            });
          }, 1000);
        }

        // Delete dashboard deletes the dashboard from the database.
        function deleteDashboard(id) {
          fetch(`/dashboards`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id: id }),
          })
            .then((response) => {
              if (response.status === 204) {
                appendAlert("Dashboard deleted successfully", "success");
                setTimeout(() => {
                  window.location.reload();
                }, 1000);
              } else {
                appendAlert("Failed to delete dashboard", "danger");
              }
            })
            .catch((error) => console.error("Error:", error));
        }

        // Append alert  adds an alert to the UI page.
        const appendAlert = (message, type) => {
          const alertDiv = document.getElementById("dashboard-alert");
          const wrapper = document.createElement("div");
          wrapper.innerHTML = [
            `<div class="alert alert-${type} alert-dismissible p-3" role="alert">`,
            `   <div>${message}</div>`,
            `   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`,
            "</div>",
          ].join("");
          alertDiv.appendChild(wrapper);
        };

        const updateDashboardModal = new bootstrap.Modal(
          document.getElementById("updateDashboardModal"),
        );
        function editDashboard(id, name, description) {
          const form = document.getElementById("update-dashboard-form");
          form.name.value = name;
          form.description.value = description;
          form.id.value = id;

          updateDashboardModal.show();
        }

        const updateButton = document.getElementById("update-dashboard-button");
        updateButton.addEventListener("click", function () {
          const form = document.getElementById("update-dashboard-form");
          const data = {
            id: form.id.value,
            name: form.name.value,
            description: form.description.value,
          };
          fetch(`/dashboards`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (response.status === 200) {
                updateDashboardModal.hide();
                appendAlert("Dashboard updated successfully", "success");
                setTimeout(() => {
                  window.location.reload();
                }, 1000);
              } else {
                updateDashboardModal.hide();
                appendAlert("Failed to update dashboard", "danger");
              }
            })
            .catch((error) => console.error("Error:", error));
        });
      </script>
    </body>
  </html>
{{ end }}
