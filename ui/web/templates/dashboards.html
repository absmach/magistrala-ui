<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "dashboards" }}
  <!doctype html>
  <html lang="en">
    <head>
      {{ template "header" }}
      <title>Dashboards</title>
    </head>
    <style>
      .card {
        transition: all 0.3s;
      }
      .card:hover {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transform: scale(1.02);
      }

      .card-actions {
        margin: 8px;
        padding: 16px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .card-link {
        text-decoration: none !important;
        color: #1d2231;
      }
    </style>
    <body>
      {{ template "navbar" . }}
      <div class="main-content pt-3">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto py-3">
              <div class="row-mb-3">
                <button class="btn body-button" type="button" onclick="newDashboard()">
                  New Dashboard
                </button>
              </div>
              <div class="row" id="dashboard-cards-container"></div>
              <div id="dashboard-loader" class="row justify-content-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div class="card-actions">
                <span>
                  Showing
                  <span id="cards-count"></span>
                  of
                  <span id="cards-total"></span>
                  cards
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Create Dashboard modal -->
      <div
        class="modal fade"
        id="createDashboardModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="createDashboardModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="createDashboardModalLabel">Create Dashboard</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <form action="/dashboards" method="post">
              <div class="modal-body">
                <div class="mb-3">
                  <label for="dashboard-name" class="form-label">Name</label>
                  <input
                    type="text"
                    class="form-control"
                    name="name"
                    id="dashboard-name"
                    placeholder="Enter the dashboard name"
                  />
                </div>
                <div class="mb-3">
                  <label for="dashboard-description" class="form-label">Description</label>
                  <textarea
                    class="form-control"
                    name="description"
                    id="dashboard-description"
                    placeholder="Enter the dashboard description"
                  ></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn body-button">Create</button>
                <button type="button" class="btn body-button" data-bs-dismiss="modal">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <script>
        const newDashboard = () => {
          const modal = new bootstrap.Modal(document.getElementById("createDashboardModal"));
          modal.show();
        };
        const cardsRow = document.getElementById("dashboard-cards-container");
        const cardCountElem = document.getElementById("cards-count");
        const cardTotalElem = document.getElementById("cards-total");
        let currentPage = 1;
        let limit = 30;
        var total, pageCount;

        const addCards = (pageIndex) => {
          currentPage = pageIndex;
          fetch(`/dashboards/list?page=${pageIndex}&limit=${limit}`, {
            method: "GET",
          })
            .then((response) => response.json())
            .then((data) => {
              createCard(data);
              total = data.total;
              cardTotalElem.innerHTML = total;
              limit = data.limit;
              pageCount = data.pages;
              const endRange = currentPage == pageCount ? total : pageIndex * limit;
              cardCountElem.innerHTML = endRange;
            })
            .catch((error) => console.error("Error:", error));
        };

        window.onload = () => {
          addCards(currentPage);
          if (currentPage === pageCount) {
            document.getElementById("dashboard-loader").remove();
          }
        };

        function createCard(data) {
          setTimeout(() => {
            data.dashboards.forEach((dashboard) => {
              const newDiv = document.createElement("div");
              newDiv.className = "col-12 col-md-6 col-lg-4 mb-3";
              newDiv.innerHTML = `
                <a href="/dashboards/${dashboard.id}" class="card-link">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">${dashboard.name}</h5>
                      <h6 class="card-subtitle mb-2 text-body-secondary">${dashboard.id}</h6>
                      <p class="card-text">
                        ${dashboard.description}
                      </p>
                    </div>
                  </div>
                </a>`;
              cardsRow.appendChild(newDiv);
            });
          }, 1000);
        }

        const handleInfiniteScroll = () => {
          let { clientHeight, scrollHeight, scrollTop } = document.documentElement;
          if (clientHeight + scrollTop + 1 >= scrollHeight) {
            addCards(currentPage + 1);
          }
          if (currentPage === pageCount) {
            removeInfiniteScroll();
          }
        };

        window.addEventListener("scroll", handleInfiniteScroll);

        const removeInfiniteScroll = () => {
          document.getElementById("dashboard-loader").remove();
          window.removeEventListener("scroll", handleInfiniteScroll);
        };
      </script>
    </body>
  </html>
{{ end }}
