<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "usergroups" }}
	<!doctype html>
	<html lang="en">
		{{ template "header" }}
		<body>
			{{ template "navbar" . }}
			<div class="main-content pt-3">
				<div class="container">
					<div class="row">
						<div class="col-lg-12 mx-auto py-3">
							<div class="row">
								<div class="buttons mb-3">
									<a
										href="/users/{{ .UserID }}"
										type="button"
										class="btn body-button"
									>
										User
									</a>
									<a
										href="/users/{{ .UserID }}/things"
										type="button"
										class="btn body-button"
									>
										User Things
									</a>
									<a
										href="/users/{{ .UserID }}/channels"
										type="button"
										class="btn body-button"
									>
										User Channels
									</a>
								</div>
								<div class="table-responsive table-container">
									<div class="d-flex flex-row justify-content-between">
										<h4>User Groups</h4>
										<button
											role="button"
											class="btn body-button"
											onclick="openGroupModal()"
										>
											<i class="fa-solid fa-plus fs-4"></i>
										</button>
										<!-- modal -->
										<div
											class="modal fade"
											id="addGroupModal"
											tabindex="-1"
											aria-labelledby="addGroupModalLabel"
											aria-hidden="true"
										>
											<div class="modal-dialog modal-dialog-centered">
												<div class="modal-content">
													<div class="modal-header">
														<h1
															class="modal-title fs-5"
															id="addGroupModalLabel"
														>
															Add Group
														</h1>
														<button
															type="button"
															class="btn-close"
															data-bs-dismiss="modal"
															aria-label="Close"
														></button>
													</div>
													<form
														action="/users/{{ .UserID }}/groups/assign?item=users"
														method="post"
													>
														<div class="modal-body">
															<div class="mb-3">
																<label for="infiniteScroll" class="form-label">
																	Group ID
																</label>
																<input
																	type="text"
																	name="groupFilter"
																	id="groupFilter"
																	placeholder="Filter by Group ID"
																/>
																<select
																	class="form-select"
																	name="groupID"
																	id="infiniteScroll"
																	size="5"
																	required
																>
																	<option disabled>select a group</option>
																</select>
															</div>
															<div class="mb-3">
																<label for="relation" class="form-label">
																	Relation
																</label>
																<select
																	class="form-control"
																	name="relation"
																	id="relation"
																	aria-describedby="relationHelp"
																	multiple
																	required
																>
																	{{ range $i, $r := .Relations }}
																		<option value="{{ $r }}">
																			{{ $r }}
																		</option>
																	{{ end }}
																</select>
																<div id="relationHelp" class="form-text">
																	Select Relation.
																</div>
															</div>
															<div class="modal-footer">
																<button
																	type="button"
																	class="btn btn-secondary"
																	data-bs-dismiss="modal"
																>
																	Cancel
																</button>
																<button type="submit" class="btn btn-primary">
																	Assign
																</button>
															</div>
														</div>
													</form>
												</div>
											</div>
										</div>
									</div>

									<ul class="nav nav-tabs" id="roleTab" role="tablist">
										<li class="nav-item" role="presentation">
											{{ $tabActive := "" }}
											<button
												class="nav-link {{ if eq .TabActive $tabActive }}
													active
												{{ end }}"
												id="view-tab"
												data-bs-toggle="tab"
												data-bs-target="#view-tab-pane"
												type="button"
												role="tab"
												aria-controls="view-tab-pane"
												aria-selected="true"
												onclick="openTab('')"
											>
												All
											</button>
										</li>
										<li class="nav-item" role="presentation">
											{{ $tabActive = "admin" }}
											<button
												class="nav-link {{ if eq .TabActive $tabActive }}
													active
												{{ end }}"
												id="admin-tab"
												data-bs-toggle="tab"
												data-bs-target="#admin-tab-pane"
												type="button"
												role="tab"
												aria-controls="admin-tab-pane"
												aria-selected="true"
												onclick="openTab('admin')"
											>
												Admin
											</button>
										</li>
										<li class="nav-item" role="presentation">
											{{ $tabActive = "editor" }}
											<button
												class="nav-link {{ if eq .TabActive $tabActive }}
													active
												{{ end }}"
												id="editor-tab"
												data-bs-toggle="tab"
												data-bs-target="#editor-tab-pane"
												type="button"
												role="tab"
												aria-controls="editor-tab-pane"
												aria-selected="false"
												onclick="openTab('editor')"
											>
												Editor
											</button>
										</li>
										<li class="nav-item" role="presentation">
											{{ $tabActive = "viewer" }}
											<button
												class="nav-link {{ if eq .TabActive $tabActive }}
													active
												{{ end }}"
												id="viewer-tab"
												data-bs-toggle="tab"
												data-bs-target="#viewer-tab-pane"
												type="button"
												role="tab"
												aria-controls="viewer-tab-pane"
												aria-selected="false"
												onclick="openTab('viewer')"
											>
												Viewer
											</button>
										</li>
									</ul>
									<div class="tab-content mt-3" id="roleTabContent">
										{{ $userID := .UserID }}
										<div
											class="tab-pane active"
											id="view-tab-pane"
											role="tabpanel"
											aria-labelledby="view-tab"
											tabindex="0"
										>
											{{ template "tableheader" . }}
											<div class="itemsTable">
												<table class="table" id="itemsTable">
													<thead>
														<tr>
															<th scope="col">Name</th>
															<th scope="col">ID</th>
															<th class="desc-col" scope="col">Description</th>
															<th class="meta-col" scope="col">Metadata</th>
															<th class="created-col" scope="col">
																Created At
															</th>
														</tr>
													</thead>
													<tbody>
														{{ range $i, $g := .Groups }}
															{{ $disableButton := false }}
															<tr>
																<td>{{ $g.Name }}</td>
																<td>
																	<div class="copy-con-container">
																		<a href="{{ printf "/groups/%s" $g.ID }}">
																			{{ $g.ID }}
																		</a>
																		<button
																			class="copy-icon"
																			onclick="copyToClipboard(this)"
																		>
																			<i class="far fa-copy"></i>
																		</button>
																	</div>
																</td>
																<td class="desc-col">{{ $g.Description }}</td>
																<td class="meta-col">
																	{{ toJSON $g.Metadata }}
																</td>
																<td class="created-col">{{ $g.CreatedAt }}</td>
															</tr>
														{{ end }}
													</tbody>
												</table>
											</div>
											{{ template "tablefooter" . }}
										</div>
										<div
											class="tab-pane"
											id="admin-tab-pane"
											role="tabpanel"
											aria-labelledby="admin-tab"
											tabindex="0"
										>
											{{ template "tableheader" . }}
											<div class="itemsTable">
												<table class="table" id="itemsTable">
													<thead>
														<tr>
															<th scope="col">Name</th>
															<th scope="col">ID</th>
															<th class="desc-col" scope="col">Description</th>
															<th class="meta-col" scope="col">Metadata</th>
															<th class="created-col" scope="col">
																Created At
															</th>
															<th class="text-center" scope="col"></th>
														</tr>
													</thead>
													<tbody>
														{{ range $i, $g := .Groups }}
															{{ $disableButton := false }}
															<tr>
																<td>{{ $g.Name }}</td>
																<td>
																	<div class="copy-con-container">
																		<a href="{{ printf "/groups/%s" $g.ID }}">
																			{{ $g.ID }}
																		</a>
																		<button
																			class="copy-icon"
																			onclick="copyToClipboard(this)"
																		>
																			<i class="far fa-copy"></i>
																		</button>
																	</div>
																</td>
																<td class="desc-col">{{ $g.Description }}</td>
																<td class="meta-col">
																	{{ toJSON $g.Metadata }}
																</td>
																<td class="created-col">{{ $g.CreatedAt }}</td>
																<td class="text-center">
																	<form
																		action="/users/{{ $userID }}/groups/unassign?item=users"
																		method="post"
																	>
																		<input
																			type="hidden"
																			name="groupID"
																			id="groupID"
																			value="{{ $g.ID }}"
																		/>
																		<input
																			type="hidden"
																			name="relation"
																			id="relation"
																			value="admin"
																		/>
																		<button
																			type="submit"
																			class="btn btn-sm"
																			{{ if
																				$disableButton
																			}}
																				disabled
																			{{ end }}
																		>
																			<i class="fas fa-trash-alt"></i>
																		</button>
																	</form>
																</td>
															</tr>
														{{ end }}
													</tbody>
												</table>
											</div>
											{{ template "tablefooter" . }}
										</div>
										<div
											class="tab-pane "
											id="editor-tab-pane"
											role="tabpanel"
											aria-labelledby="editor-tab"
											tabindex="0"
										>
											{{ template "tableheader" . }}
											<div class="itemsTable">
												<table class="table" id="itemsTable">
													<thead>
														<tr>
															<th scope="col">Name</th>
															<th scope="col">ID</th>
															<th class="desc-col" scope="col">Description</th>
															<th class="meta-col" scope="col">Metadata</th>
															<th class="created-col" scope="col">
																Created At
															</th>
															<th class="text-center" scope="col"></th>
														</tr>
													</thead>
													<tbody>
														{{ range $i, $g := .Groups }}
															{{ $disableButton := false }}
															<tr>
																<td>{{ $g.Name }}</td>
																<td>
																	<div class="copy-con-container">
																		<a href="{{ printf "/groups/%s" $g.ID }}">
																			{{ $g.ID }}
																		</a>
																		<button
																			class="copy-icon"
																			onclick="copyToClipboard(this)"
																		>
																			<i class="far fa-copy"></i>
																		</button>
																	</div>
																</td>
																<td class="desc-col">{{ $g.Description }}</td>
																<td class="meta-col">
																	{{ toJSON $g.Metadata }}
																</td>
																<td class="created-col">{{ $g.CreatedAt }}</td>
																<td class="text-center">
																	<form
																		action="/users/{{ $userID }}/groups/unassign?item=users"
																		method="post"
																	>
																		<input
																			type="hidden"
																			name="groupID"
																			id="groupID"
																			value="{{ $g.ID }}"
																		/>
																		<input
																			type="hidden"
																			name="relation"
																			id="relation"
																			value="editor"
																		/>
																		<button
																			type="submit"
																			class="btn btn-sm"
																			{{ if
																				$disableButton
																			}}
																				disabled
																			{{ end }}
																		>
																			<i class="fas fa-trash-alt"></i>
																		</button>
																	</form>
																</td>
															</tr>
														{{ end }}
													</tbody>
												</table>
											</div>
											{{ template "tablefooter" . }}
										</div>
										<div
											class="tab-pane"
											id="viewer-tab-pane"
											role="tabpanel"
											aria-labelledby="viewer-tab"
											tabindex="0"
										>
											{{ template "tableheader" . }}
											<div class="itemsTable">
												<table class="table" id="itemsTable">
													<thead>
														<tr>
															<th scope="col">Name</th>
															<th scope="col">ID</th>
															<th class="desc-col" scope="col">Description</th>
															<th class="meta-col" scope="col">Metadata</th>
															<th class="created-col" scope="col">
																Created At
															</th>
															<th class="text-center" scope="col"></th>
														</tr>
													</thead>
													<tbody>
														{{ $userID := .UserID }}
														{{ range $i, $g := .Groups }}
															{{ $disableButton := false }}
															<tr>
																<td>{{ $g.Name }}</td>
																<td>
																	<div class="copy-con-container">
																		<a href="{{ printf "/groups/%s" $g.ID }}">
																			{{ $g.ID }}
																		</a>
																		<button
																			class="copy-icon"
																			onclick="copyToClipboard(this)"
																		>
																			<i class="far fa-copy"></i>
																		</button>
																	</div>
																</td>
																<td class="desc-col">{{ $g.Description }}</td>
																<td class="meta-col">
																	{{ toJSON $g.Metadata }}
																</td>
																<td class="created-col">{{ $g.CreatedAt }}</td>
																<td class="text-center">
																	<form
																		action="/users/{{ $userID }}/groups/unassign?item=users"
																		method="post"
																	>
																		<input
																			type="hidden"
																			name="groupID"
																			id="groupID"
																			value="{{ $g.ID }}"
																		/>
																		<input
																			type="hidden"
																			name="relation"
																			id="relation"
																			value="viewer"
																		/>
																		<button
																			type="submit"
																			class="btn btn-sm"
																			{{ if
																				$disableButton
																			}}
																				disabled
																			{{ end }}
																		>
																			<i class="fas fa-trash-alt"></i>
																		</button>
																	</form>
																</td>
															</tr>
														{{ end }}
													</tbody>
												</table>
											</div>
											{{ template "tablefooter" . }}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			{{ template "footer" }}
			<script>
				const groupModal = new bootstrap.Modal(
					document.getElementById("addGroupModal"),
				);
				function openGroupModal() {
					groupModal.show();
				}

				fetchIndividualEntity({
					input: "groupFilter",
					itemSelect: "infiniteScroll",
					item: "groups",
				});

				function openTab(relation) {
					event.preventDefault();
                    var userID = '{{.UserID}}';
                    fetch(`/users/${userID}/groups?relation=${relation}`, {
                        method: "GET",
                    })
                        .then((response) => {

                        })
                        .catch((error) => console.error("Error:", error));
				}
			</script>
		</body>
	</html>
{{ end }}
