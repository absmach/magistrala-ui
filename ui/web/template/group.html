{{define "group"}}
<!doctype html>
<html lang="en">
{{template "header"}}

<body>
  {{template "navbar" .}}

  <div class="main-content">
    <main>
      <a class="btn body-button" href="/groups/{{.Group.ID}}/members" role="button">Connections</a>
      
      <div class="table-container">
        <table id="myTable" class="table">
          <thead>
            <tr>
              <th scope="row">GROUP</th>
            </tr>
          </thead>
          <tbody>
            {{$disableButton := true}}
            {{if (authorizeUser .User.ID .Group.ID "g_update" "group")}}
              {{$disableButton =false}}
            {{end}}
            <tr>
              <th>NAME</th>
              <td class="editable" contenteditable="false" data-field="name">
                {{.Group.Name}}
              </td>
              <td>
                <button class="edit-btn" onclick="editRow('name')" {{if $disableButton}}disabled{{end}}>
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <div class="save-cancel-buttons" style="display: none;">
                  <button class="save-btn" onclick="saveRow('name')">
                    Save
                  </button>
                  <button class="cancel-btn" onclick="cancelEditRow('name')">
                    Cancel
                  </button>
                </div>
              </td>
            </tr>
            <tr>
              <th>ID</th>
              <td>
                {{.Group.ID}}
              </td>
            </tr>
            <tr>
              <th>Description</th>
              <td class="editable" contenteditable="false" data-field="description">
                {{.Group.Description}}
              </td>
              <td>
                <button class="edit-btn" onclick="editRow('description')" {{if $disableButton}}disabled{{end}}>
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <div class="save-cancel-buttons" style="display: none;">
                  <button class="save-btn" onclick="saveRow('description')">
                    Save
                  </button>
                  <button class="cancel-btn" onclick="cancelEditRow('description')">
                    Cancel
                  </button>
                </div>
              </td>
            </tr>
            <tr>
              <th>Metadata</th>
              <td class="editable" contenteditable="false" data-field="metadata">
                {{toJSON .Group.Metadata}}
              </td>
              <td>
                <button class="edit-btn" onclick="editRow('metadata')" {{if $disableButton}}disabled{{end}}>
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <div class="save-cancel-buttons" style="display: none;">
                  <button class="save-btn" onclick="saveRow('metadata')">
                    Save
                  </button>
                  <button class="cancel-btn" onclick="cancelEditRow('metadata')">
                    Cancel
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <div id="error-message" class="error-message"></div>
      </div>
    </main>
  </div>

  {{template "footer"}}
  <script>
    function makeEditable(cell) {
      cell.setAttribute("contenteditable", "true");
      cell.dataset.originalContent = cell.innerHTML;
    }

    function makeUneditable(cell) {
      const originalContent = cell.dataset.originalContent;
      cell.innerHTML = originalContent;
      cell.setAttribute("contenteditable", "false");
    }

    function showButtons(editBtn, saveCancelBtn) {
      editBtn.style.display = "none";
      saveCancelBtn.style.display = "inline-block";
    }
    function hideButtons(editBtn, saveCancelBtn) {
      editBtn.style.display = "inline-block";
      saveCancelBtn.style.display = "none";
    }

    function editRow(field) {
      const cell = document.querySelector(`td[data-field='${field}']`);
      const editBtn = cell.parentNode.querySelector(".edit-btn");
      const saveCancelBtn = cell.parentNode.querySelector(".save-cancel-buttons");

      //make the row editable
      makeEditable(cell);

      //Hide edit button and show save and cancel buttons
      showButtons(editBtn, saveCancelBtn);
    }

    function cancelEditRow(field) {
      const cell = document.querySelector(`td[data-field='${field}']`);
      const editBtn = cell.parentNode.querySelector(".edit-btn");
      const saveCancelBtn = cell.parentNode.querySelector(".save-cancel-buttons");
      const errorMessage = document.getElementById("error-message");

      errorMessage.textContent= '';

      //Restore original values in the row
      makeUneditable(cell);

      //show the edit button and hide the save and cancel buttons
      hideButtons(editBtn, saveCancelBtn);
    }

    function saveRow(field) {
      const cell = document.querySelector(`td[data-field='${field}']`);
      const editBtn = cell.parentNode.querySelector(".edit-btn");
      const saveCancelBtn = cell.parentNode.querySelector(".save-cancel-buttons");
      const errorMessage = document.getElementById("error-message");

      //Get the updated value from the nameCell
      const updatedValue = cell.textContent.trim();

      //send the updated value to the server using a post request
      let url;
      let data;
      if (field === 'name' || field === 'description') {
        url = '/groups/{{.Group.ID}}';
        data = {[field]: updatedValue};
      }else if(field === 'metadata') {
        try {
          const metadata = JSON.parse(updatedValue);
          url = '/groups/{{.Group.ID}}';
          data = { [field]: metadata };
        } catch (error) {
          errorMessage.textContent = 'Metadata must be a valid JSON object!';
          return;
        }
      }

      if (url) {
        fetch(url, {
          method: "POST",
          body: JSON.stringify(data),
          headers: {
            "Content-Type": "application/json"
          }
        })
        .then(response => {
          if (response.ok) {
            //make the row uneditable
            cell.setAttribute("contenteditable","false");

            //show edit button and hide save and cancel buttons
            hideButtons(editBtn, saveCancelBtn);
          }else{
            throw new Error(response.statusText);
            console.log(response.statusText)
          }
        })
        .catch(error => {
          //Restore original values in the row if there is an error
          makeUneditable(cell);

          //show edit button and hide save and cancel buttons
          hideButtons(editBtn, saveCancelBtn);

          console.error("Error", error);
          errorMessage.textContent= "Entity already exists";
        });
      } else {
        console.error("Invalid field:", field);
      }

    } 

  </script>
</body>
</html>
{{end}}
