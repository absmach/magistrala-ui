<!-- Copyright (c) Abstract Machines
SPDX-License-Identifier: Apache-2.0 -->

{{ define "dashboard" }}
  <!doctype html>
  <html lang="en">
    <head>
      {{ template "header" }}
      <title>Dashboard</title>
      <script src="https://cdn.jsdelivr.net/npm/muuri@0.9.5/dist/muuri.min.js"></script>
    </head>
    <body>
      {{ template "navbar" . }}
      <div class="main-content pt-3">
        <div class="container">
          <div class="row">
            <div class="col-lg-12 mx-auto py-3">
              <div class="row">
                <div class="row-mb-3 display-none" id="CanvasButtons">
                  <button
                    type="button"
                    class="btn body-button"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#widgetsCanvas"
                    aria-controls="widgetsCanvas"
                  >
                    Add Widgets
                  </button>
                  <button type="button" class="btn body-button" onclick="saveCanvas()">
                    Save Layout
                  </button>
                  <button type="button" class="btn body-button" onclick="cancelEdit()">
                    Cancel
                  </button>
                </div>
                <div class="row-mb-3" id="editableCanvasButton">
                  <button type="button" class="btn body-button" onclick="editableCanvas()">
                    Edit Canvas
                  </button>
                </div>
                <div class="row">
                  <div class="grid"></div>
                </div>

                <!-- Off canvas containing the chart widgets -->
                <div
                  class="offcanvas offcanvas-end"
                  data-bs-scroll="true"
                  data-bs-backdrop="false"
                  tabindex="-1"
                  id="widgetsCanvas"
                  aria-labelledby="widgetsCanvasLabel"
                >
                  <div class="offcanvas-header">
                    <h5 id="widgetsCanvasLabel">Widgets</h5>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="offcanvas"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="offcanvas-body">
                    {{ range $chart := .Charts }}
                      <div
                        class="card mb-3"
                        style="width: 18rem; cursor: pointer;"
                        onclick="openWidgetModal('{{ $chart.Widget }}')"
                      >
                        <div class="card-body">
                          <div class="card-title">
                            {{ $chart.Title }}
                          </div>
                          <div class="card-text">
                            {{ $chart.Content }}
                          </div>
                          <img src="{{ $chart.Image }}" class="card-img" alt="" />
                        </div>
                      </div>
                    {{ end }}
                  </div>
                </div>
              </div>

              {{ template "gaugemodal" . }}
              {{ template "linechartmodal" . }}
            </div>
          </div>
        </div>
      </div>
      <script>
        initGrid();
        var grid;

        function initGrid() {
          var savedLayout = window.localStorage.getItem("gridState");
          if (savedLayout) {
            loadLayout(savedLayout);
          } else {
            grid = new Muuri(".grid", {
              dragEnabled: true,
            });
          }
        }

        function saveLayout(grid) {
          const itemData = grid.getItems().map((item) => ({
            innerHTML: item.getElement().innerHTML,
          }));

          const gridState = {
            items: itemData,
            layout: grid._layout,
            settings: {
              dragEnabled: grid._settings.dragEnabled,
              // Add other relevant settings if needed
            },
          };

          // Convert the gridState to a JSON string
          const jsonString = JSON.stringify(gridState, function (key, value) {
            // Exclude circular references
            if (key === "_item" || key === "_grid" || key === "_layout") {
              return undefined;
            }
            return value;
          });

          localStorage.setItem("gridState", jsonString);
        }

        function loadLayout(savedLayout) {
          try {
            const gridState = JSON.parse(savedLayout);
            // Clear the existing grid
            if (grid) {
              grid.destroy(true);
            }

            grid = new Muuri(".grid", {
              dragEnabled: gridState.settings.dragEnabled,
              // Add any other relevant settings
            });

            // Add items to the grid based on the saved state
            gridState.items.forEach((itemData) => {
              const newItem = document.createElement("div");
              newItem.className = "item";
              newItem.innerHTML = itemData.innerHTML.trim();
              const item = grid.add(newItem);
            });

            // Layout the grid
            grid.layout(gridState.layout);
          } catch (error) {
            console.error("Error loading grid state:", error);
          }
        }

        function addWidget(data) {
          // Create a new grid item
          const newItem = document.createElement("div");
          newItem.className = "item";
          newItem.classList.add("item-editable");
          newItem.innerHTML = `
            <button type="button" class="btn btn-sm" id="removeItem" onclick="removeGridItem(this.parentNode);">
              <i class="fas fa-trash-can"></i>
            </button>
            <div class="item-content">
              ${data}
            </div>`;

          grid.add(newItem);
        }

        function removeGridItem(item) {
          grid.remove(grid.getItems(item), { removeElements: true });
        }

        function openWidgetModal(widget) {
          const widgetModal = new bootstrap.Modal(document.getElementById(`${widget}Modal`));
          widgetModal.show();
        }

        // Editable canvas is used to make the canvas editable allowing the user to add widgets and be able to move the
        // widgets around the canvas
        function editableCanvas() {
          var savedLayout = window.localStorage.getItem("gridState");
          try {
            const gridState = JSON.parse(savedLayout);
            if (grid) {
              grid.destroy(true);
            }
            grid = new Muuri(".grid", {
              dragEnabled: true,
            });
            if (gridState) {
              gridState.items.forEach((itemData) => {
                const newItem = document.createElement("div");
                newItem.className = "item";
                newItem.innerHTML = itemData.innerHTML.trim();
                const item = grid.add(newItem);
              });
              grid.layout(gridState.layout);
            }
          } catch (error) {
            console.error("Error loading grid state:", error);
          }

          document.getElementById("editableCanvasButton").classList.add("display-none");
          document.getElementById("CanvasButtons").classList.remove("display-none");
          document.querySelectorAll("#removeItem").forEach((item) => {
            item.classList.remove("no-opacity");
            item.disabled = false;
          });
          document.querySelectorAll(".item").forEach((item) => {
            item.classList.add("item-editable");
          });
        }

        function saveCanvas() {
          grid._settings.dragEnabled = false;
          document.querySelectorAll("#removeItem").forEach((item) => {
            item.classList.add("no-opacity");
            item.disabled = true;
          });
          saveLayout(grid);
          window.location.reload();
        }

        function cancelEdit() {
          grid._settings.dragEnabled = false;
          window.location.reload();
        }
      </script>
    </body>
  </html>
{{ end }}
